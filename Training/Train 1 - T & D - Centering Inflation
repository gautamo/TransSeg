{"cells":[{"cell_type":"markdown","metadata":{"id":"15-8cpuYREiL"},"source":["This Colab Notebook performs end to end installation process for the GitHub Repo: https://github.com/yuhui-zh15/TransSeg. Install takes about 20 min total. At the end, you can run the training step."]},{"cell_type":"markdown","metadata":{"id":"Lgetoa9tmKTB"},"source":["## Setup & Installation Section"]},{"cell_type":"markdown","metadata":{"id":"LtauOzycSL9W"},"source":["Mount Google Drive"]},{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":19720,"status":"ok","timestamp":1683000991498,"user":{"displayName":"UIUC UIUC","userId":"08181960678455443916"},"user_tz":420},"id":"piKUQtYLSOR6","outputId":"aa3a7774-6c81-4870-f6db-9ba2fa11e5a7"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /gdrive\n"]}],"source":["from google.colab import drive\n","drive.mount('/gdrive')"]},{"cell_type":"markdown","metadata":{"id":"RmbTYRAaFMn3"},"source":["Update GCC Version to 8"]},{"cell_type":"code","execution_count":2,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":16730,"status":"ok","timestamp":1683001008223,"user":{"displayName":"UIUC UIUC","userId":"08181960678455443916"},"user_tz":420},"id":"mxCSqEpfn17M","outputId":"93efbced-1851-4f70-c6ad-def2c7a3c543"},"outputs":[{"output_type":"stream","name":"stdout","text":["Reading package lists... Done\n","Building dependency tree       \n","Reading state information... Done\n","The following additional packages will be installed:\n","  cpp-8 gcc-8-base libgcc-8-dev libmpx2 libstdc++-8-dev\n","Suggested packages:\n","  gcc-8-locales g++-8-multilib gcc-8-doc gcc-8-multilib libstdc++-8-doc\n","The following NEW packages will be installed:\n","  cpp-8 g++-8 gcc-8 gcc-8-base libgcc-8-dev libmpx2 libstdc++-8-dev\n","0 upgraded, 7 newly installed, 0 to remove and 24 not upgraded.\n","Need to get 32.8 MB of archives.\n","After this operation, 115 MB of additional disk space will be used.\n","Get:1 http://archive.ubuntu.com/ubuntu focal/universe amd64 gcc-8-base amd64 8.4.0-3ubuntu2 [18.7 kB]\n","Get:2 http://archive.ubuntu.com/ubuntu focal/universe amd64 cpp-8 amd64 8.4.0-3ubuntu2 [8,945 kB]\n","Get:3 http://archive.ubuntu.com/ubuntu focal/universe amd64 libmpx2 amd64 8.4.0-3ubuntu2 [11.8 kB]\n","Get:4 http://archive.ubuntu.com/ubuntu focal/universe amd64 libgcc-8-dev amd64 8.4.0-3ubuntu2 [2,313 kB]\n","Get:5 http://archive.ubuntu.com/ubuntu focal/universe amd64 gcc-8 amd64 8.4.0-3ubuntu2 [9,833 kB]\n","Get:6 http://archive.ubuntu.com/ubuntu focal/universe amd64 libstdc++-8-dev amd64 8.4.0-3ubuntu2 [1,537 kB]\n","Get:7 http://archive.ubuntu.com/ubuntu focal/universe amd64 g++-8 amd64 8.4.0-3ubuntu2 [10.1 MB]\n","Fetched 32.8 MB in 2s (13.2 MB/s)\n","Selecting previously unselected package gcc-8-base:amd64.\n","(Reading database ... 122518 files and directories currently installed.)\n","Preparing to unpack .../0-gcc-8-base_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking gcc-8-base:amd64 (8.4.0-3ubuntu2) ...\n","Selecting previously unselected package cpp-8.\n","Preparing to unpack .../1-cpp-8_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking cpp-8 (8.4.0-3ubuntu2) ...\n","Selecting previously unselected package libmpx2:amd64.\n","Preparing to unpack .../2-libmpx2_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking libmpx2:amd64 (8.4.0-3ubuntu2) ...\n","Selecting previously unselected package libgcc-8-dev:amd64.\n","Preparing to unpack .../3-libgcc-8-dev_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking libgcc-8-dev:amd64 (8.4.0-3ubuntu2) ...\n","Selecting previously unselected package gcc-8.\n","Preparing to unpack .../4-gcc-8_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking gcc-8 (8.4.0-3ubuntu2) ...\n","Selecting previously unselected package libstdc++-8-dev:amd64.\n","Preparing to unpack .../5-libstdc++-8-dev_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking libstdc++-8-dev:amd64 (8.4.0-3ubuntu2) ...\n","Selecting previously unselected package g++-8.\n","Preparing to unpack .../6-g++-8_8.4.0-3ubuntu2_amd64.deb ...\n","Unpacking g++-8 (8.4.0-3ubuntu2) ...\n","Setting up gcc-8-base:amd64 (8.4.0-3ubuntu2) ...\n","Setting up libmpx2:amd64 (8.4.0-3ubuntu2) ...\n","Setting up cpp-8 (8.4.0-3ubuntu2) ...\n","Setting up libgcc-8-dev:amd64 (8.4.0-3ubuntu2) ...\n","Setting up libstdc++-8-dev:amd64 (8.4.0-3ubuntu2) ...\n","Setting up gcc-8 (8.4.0-3ubuntu2) ...\n","Setting up g++-8 (8.4.0-3ubuntu2) ...\n","Processing triggers for man-db (2.9.1-1) ...\n","Processing triggers for libc-bin (2.31-0ubuntu9.9) ...\n","update-alternatives: using /usr/bin/gcc-8 to provide /usr/bin/gcc (gcc) in auto mode\n"]}],"source":["!apt install -y --no-install-recommends gcc-8 g++-8\n","!update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 800 --slave /usr/bin/g++ g++ /usr/bin/g++-8"]},{"cell_type":"markdown","metadata":{"id":"z7LlvJj1Eg-i"},"source":["Install Cuda 10.1. Install is 10 min. Follow all install requests, including entering keyboad and language information when prompted."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"eDOLMd5aOgHu"},"outputs":[],"source":["!export DEBIAN_FRONTEND=noninteractive\n","!wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu1804.pin\n","!sudo mv cuda-ubuntu1804.pin /etc/apt/preferences.d/cuda-repository-pin-600\n","!wget https://developer.download.nvidia.com/compute/cuda/10.1/Prod/local_installers/cuda-repo-ubuntu1804-10-1-local-10.1.243-418.87.00_1.0-1_amd64.deb\n","!sudo dpkg -i cuda-repo-ubuntu1804-10-1-local-10.1.243-418.87.00_1.0-1_amd64.deb\n","!sudo apt-key add /var/cuda-repo-10-1-local-10.1.243-418.87.00/7fa2af80.pub\n","!sudo apt-get update -y\n","!sudo apt-get -y install cuda-10-1\n","\n","!nvcc --version\n","!nvidia-smi"]},{"cell_type":"markdown","metadata":{"id":"QilY9TL5RLRB"},"source":["Install Miniconda"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"E5VZIpDgQwXQ"},"outputs":[],"source":["%cd /content\n","!wget https://repo.anaconda.com/miniconda/Miniconda3-py38_4.9.2-Linux-x86_64.sh\n","!chmod +x Miniconda3-py38_4.9.2-Linux-x86_64.sh\n","!bash ./Miniconda3-py38_4.9.2-Linux-x86_64.sh -b -f -p /usr/local\n","\n","import sys\n","sys.path.append('/usr/local/lib/python3.8/site-packages')"]},{"cell_type":"markdown","metadata":{"id":"rnbUiGvVRRat"},"source":["Install Conda libraries"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"MeTZCe_PRWhP"},"outputs":[],"source":["!conda install --yes -c rmg -c conda-forge -c rdkit -c pytorch -c defaults --file /gdrive/MyDrive/TransSeg/conda_requirements.txt"]},{"cell_type":"markdown","metadata":{"id":"S-oYn8IARZ7I"},"source":["Install Pip Libraries"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"cfW9wMMaRaLz"},"outputs":[],"source":["# Version should be 3.8.11 from Conda Installation\n","!python -V\n","!pip install -r /gdrive/MyDrive/TransSeg/pip_requirements.txt"]},{"cell_type":"markdown","metadata":{"id":"PCBuqPaEMQ1n"},"source":["Install torch compiled with cuda 10.1"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"f20ZqUSQ7EUK"},"outputs":[],"source":["!pip uninstall -y torch torchvision\n","!pip install torch==1.7.1+cu101 torchvision==0.8.2+cu101 -f https://download.pytorch.org/whl/torch_stable.html"]},{"cell_type":"markdown","metadata":{"id":"3jPdNTQkRaVd"},"source":["Deepspeed Installation (This was removed from environment.yml file as installation process required prerequisite libraries)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"oBumQUvAWcfS"},"outputs":[],"source":["!pip install deepspeed==0.4.0"]},{"cell_type":"markdown","metadata":{"id":"mn0iyLceRsIh"},"source":["Apex Installation. This was removed from environment.yml file as installation process is more involved than pip install."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"waTRGAktyS9x"},"outputs":[],"source":["%cd /content\n","!pip uninstall apex\n","!rm -rf apex\n","!git clone https://github.com/NVIDIA/apex\n","%cd apex\n","!git checkout 22.04-dev\n","!pip install -v --disable-pip-version-check --no-cache-dir --global-option=\"--cpp_ext\" --global-option=\"--cuda_ext\" ./\n","%cd .."]},{"cell_type":"markdown","metadata":{"id":"_kS50zPOMyBc"},"source":["DO NOT RUN: Step in case weights are not downloaded (weights are already downloaded)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"1yH_NyjZwQGs"},"outputs":[],"source":["# only needs to be done if error is: FileNotFoundError: [Errno 2] No such file or directory: 'backbones/encoders/pretrained_models/beit_base_patch16_224_pt22k_ft22k.pth'\n","\n","# %cd /gdrive/MyDrive/TransSeg/src/backbones/encoders/pretrained_models\n","# !ls\n","# !bash download_weights.sh\n","# %cd /content"]},{"cell_type":"markdown","metadata":{"id":"SIqP5eJcNuGu"},"source":["Some Basic Install Stats"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"ahF1uZWx6Qi1"},"outputs":[],"source":["!nvcc --version\n","!python --version\n","\n","import torch\n","print(torch.cuda.is_available())"]},{"cell_type":"markdown","metadata":{"id":"AHTTcnUqcquz"},"source":["DO NOT RUN: Preprocess the Data (All Data is preproocessed, except MSD has 9 other datasets which need to be installed and preprocessed, consult with Gautam)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"998vhgIfclEi"},"outputs":[],"source":["# data is already processed hence commented, kept here for understanding the process\n","\n","# %cd /gdrive/MyDrive/TransSeg/src/data/bcv/\n","# !python3 split_data_to_slices_nii.py\n","# %cd /gdrive/MyDrive/TransSeg/src/data/acdc/\n","# !python3 split_data_to_slices_nii.py\n","# %cd /gdrive/MyDrive/TransSeg/src/data/msd/\n","# !python3 split_data_to_slices_nii.py\n","# %cd /content/"]},{"cell_type":"markdown","metadata":{"id":"xYFbEDm4mDaq"},"source":["## TRAINING\n","In order to recreate the results, we need to train 4 models on the BCV dataset.\n","\n","*   Model w/o T&D\n","*   Model w/o T\n","*   Model w/o D\n","*   Model\n","\n","The model will be trained on the BCV dataset using the default BEiT encoder (Source Table 2b.), default UPerNet decoder (Source Figure 1), and default Dice Focal Loss (not mentioned in paper, but is the default in code).\n","\n","These 4 models can be used to recreate the data from Table 2a by evaluating the models on the BCV dataset.\n","\n","Once the 4 BCV models are trained, Table 3 can be created by evaluating the model on the BCV dataset segmented into the 8 individual methods, I'm not sure how we can get these 8 methods though.\n","\n","Once the 4 BCV models are trained, Table 5 can be recreated by evaluating the model on all the datasets in the table. Right now only the ACDC and MSD_Task09_Spleen data is in the drive repo, so the rest of the MSD data needs to be downloaded and processed."]},{"cell_type":"markdown","metadata":{"id":"4Ay84RCDF6w-"},"source":["Let's train on the bcv dataset! \n","\n","Each epoch takes about 1 hour to train, and to get to 25000 max steps takes about 24 hours.\n","\n","The script below performs training with T & D - Transfer Learning & Depth Information, and 3 other permutations. Uncomment the permutation you want to train on if you want to train.\n","\n","Train scripts are set to 5000 steps, but should be updated for more steps when doing full evaluation."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"TSrcsRRirInu"},"outputs":[],"source":["%cd /gdrive/MyDrive/TransSeg/src\n","\n","# 1. Uses T & D - Centering Inflation\n","!bash scripts/train_bcv_centering.sh\n","\n","# 2. No D - Centering Inflation\n","# !bash scripts/train_bcv_wod_centering.sh\n","\n","# 3. No T - Centering Inflation\n","# !bash scripts/train_bcv_wot_centering.sh\n","\n","# 4. No T & D - Centering Inflation\n","# !bash scripts/train_bcv_wotd_centering.sh\n","\n","\n","# 5. Uses T & D - Averaging Inflation\n","# !bash scripts/train_bcv_inflation.sh\n","\n","# 6. No D - Averaging Inflation\n","# !bash scripts/train_bcv_wod_inflation.sh\n","\n","# 7. No T - Averaging Inflation\n","# !bash scripts/train_bcv_wot_inflation.sh\n","\n","# 8. No T & D - Averaging Inflation\n","# !bash scripts/train_bcv_wotd_inflation.sh\n","\n","\n","# 9. Uses T & D - Linear Inflation\n","# !bash scripts/train_bcv_linear.sh\n","\n","# 10. No D - Linear Inflation\n","# !bash scripts/train_bcv_wod_linear.sh\n","\n","# 11. No T - Linear Inflation\n","# !bash scripts/train_bcv_wot_linear.sh\n","\n","# 12. No T & D - Linear Inflation\n","# !bash scripts/train_bcv_wotd_linear.sh"]}],"metadata":{"accelerator":"GPU","colab":{"provenance":[],"mount_file_id":"1HG5eiv5bszxGDk5FwltRAAy-5ggHO9s4","authorship_tag":"ABX9TyNeA0iWR8jju06txDNp9kOS"},"gpuClass":"standard","kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}